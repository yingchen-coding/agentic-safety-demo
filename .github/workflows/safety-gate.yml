# Safety Release Gate - GitHub Actions Integration
name: Safety Release Gate

on:
  pull_request:
    branches: [main]

jobs:
  safety-regression:
    name: Safety Regression Tests
    runs-on: ubuntu-latest
    outputs:
      verdict: ${{ steps.gate.outputs.verdict }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run regression suite
        id: regression
        run: |
          python scripts/step3_run_release_gate.py \
            --baseline main \
            --candidate ${{ github.head_ref }}
        continue-on-error: true

      - name: Parse gate verdict
        id: gate
        run: |
          VERDICT=$(cat artifacts/gate_report.json | python -c "import sys,json; print(json.load(sys.stdin)['verdict'])")
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: artifacts/gate_report.html

  gate-decision:
    needs: [safety-regression]
    runs-on: ubuntu-latest
    steps:
      - name: Check verdict
        run: |
          if [ "${{ needs.safety-regression.outputs.verdict }}" = "BLOCK" ]; then
            echo "::error::Safety gate BLOCKED"
            exit 1
          fi
